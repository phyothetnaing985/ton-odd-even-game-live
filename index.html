<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden ODD-EVEN | Audited Version</title>
    
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tonweb@0.0.66/dist/tonweb.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* မူလ UI style အတိုင်း ထားရှိပါသည် */
        :root { --gold: #FFD700; --bg: #0b0f1a; --card: #161b2c; --text: #ffffff; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding-bottom: 90px; }
        .container { padding: 15px; max-width: 450px; margin: auto; }
        .glass-card { background: var(--card); border-radius: 20px; padding: 20px; border: 1px solid rgba(255,215,0,0.1); margin-bottom: 20px; }
        .btn-main { background: linear-gradient(135deg, #FFD700, #B8860B); color: #000; border: none; padding: 15px; border-radius: 12px; font-weight: bold; width: 100%; cursor: pointer; }
        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .select-btn { padding: 15px; border: 1px solid #2d3748; border-radius: 10px; background: transparent; color: #fff; cursor: pointer; }
        .select-btn.active { border-color: var(--gold); color: var(--gold); background: rgba(255,215,0,0.1); }
        .hidden { display: none; }
    </style>
</head>
<body>

    <header style="padding: 15px; display: flex; justify-content: flex-end; background: var(--card);">
        <div id="ton-connect"></div>
    </header>

    <div class="container">
        <div id="play-section">
            <div class="glass-card">
                <img src="https://i.postimg.cc/8zfNZBQP/IMG-20260115-210803.png" style="width:100%; border-radius:15px; margin-bottom:15px;">
                <div style="display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px;">
                    <span>Bet: <span id="bet-val">0.1</span> TON</span>
                    <span>Win: <span style="color:#10b981;">0.19 TON</span></span>
                </div>
                <input type="range" min="0.1" max="1.0" step="0.1" value="0.1" style="width:100%; accent-color:var(--gold);" oninput="document.getElementById('bet-val').innerText=this.value; currentBet=this.value;">
                
                <div class="selection-grid">
                    <button id="btn-even" class="select-btn" onclick="setSide(true)">EVEN</button>
                    <button id="btn-odd" class="select-btn" onclick="setSide(false)">ODD</button>
                </div>
                <button class="btn-main" onclick="handlePlaceBet()">PLACE BET NOW</button>
            </div>
        </div>
    </div>

    <script>
        const CONTRACT_ADDRESS = "EQDrMfp_8qbmmnp6mNsg-arxKY2oNvic1kmWovr6_2kFVNK";
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://phyothetnaing985.github.io/ton-odd-even-game-live/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        let currentSide = null;
        let currentBet = 0.1;

        function setSide(s) {
            currentSide = s;
            document.getElementById('btn-even').classList.toggle('active', s);
            document.getElementById('btn-odd').classList.toggle('active', !s);
        }

        async function handlePlaceBet() {
            if (!tonConnectUI.connected) return alert("Connect Wallet First!");
            if (currentSide === null) return alert("Select EVEN or ODD!");

            // အမတ်ကြီးရဲ့ Pre-validation Logic
            try {
                // TonWeb ရှိမရှိ အရင်စစ်မယ် (အရေးကြီးဆုံး)
                if (typeof window.TonWeb === 'undefined') {
                    return alert("TonWeb Library is loading... please wait 2 seconds.");
                }

                const tonWeb = new window.TonWeb();
                
                // ၁။ Contract Balance စစ်ဆေးခြင်း (Failed Tx မဖြစ်အောင်)
                const info = await fetch(`https://toncenter.com/api/v2/getAddressInformation?address=${CONTRACT_ADDRESS}`).then(r => r.json());
                const balance = parseInt(info.result.balance);
                const payoutNeeded = TonWeb.utils.toNano((currentBet * 1.9).toString());

                if (balance < (parseInt(payoutNeeded) + 500000000)) { // 0.5 TON reserve
                    return alert("House balance low! Try again later.");
                }

                // ၂။ Transaction တည်ဆောက်ခြင်း
                const cell = new TonWeb.boc.Cell();
                cell.bits.writeUint(0x65228565, 32); // Bet Opcode
                cell.bits.writeBit(currentSide);
                cell.bits.writeBit(0); // No referrer for basic bet

                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{
                        address: CONTRACT_ADDRESS,
                        amount: TonWeb.utils.toNano(currentBet.toString()).toString(),
                        payload: TonWeb.utils.bytesToBase64(await cell.toBoc())
                    }]
                };

                await tonConnectUI.sendTransaction(tx);
                alert("Transaction Sent!");

            } catch (e) {
                alert("Error: " + e.message);
            }
        }
    </script>
</body>
</html>
