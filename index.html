<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Golden ODD-EVEN | Premium TON Game</title>
    
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tonweb/0.0.66/tonweb.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root { --gold: #FFD700; --bg: #0b0f1a; --card: #161b2c; --text: #ffffff; }
        body.light-mode { --bg: #f1f5f9; --card: #ffffff; --text: #0f172a; }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; padding-bottom: 90px; transition: 0.3s; }
        
        /* Header */
        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card); border-bottom: 1px solid rgba(255,215,0,0.2); position: sticky; top: 0; z-index: 1000; }
        .container { padding: 15px; max-width: 450px; margin: auto; }
        .glass-card { background: var(--card); border-radius: 24px; padding: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.4); margin-bottom: 20px; border: 1px solid rgba(255,215,0,0.1); }
        
        /* Elements */
        .banner-img { width: 100%; border-radius: 18px; margin-bottom: 15px; border: 1px solid var(--gold); }
        .btn-main { background: linear-gradient(135deg, #FFD700, #B8860B); color: #000; border: none; padding: 18px; border-radius: 16px; font-weight: 800; width: 100%; cursor: pointer; font-size: 1rem; text-transform: uppercase; transition: 0.2s; }
        .btn-main:active { transform: scale(0.97); }

        /* Selection */
        .selection-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 0; }
        .select-btn { padding: 20px; border: 2px solid #2d3748; border-radius: 16px; background: rgba(255,255,255,0.03); color: var(--text); font-weight: 900; cursor: pointer; font-size: 1.2rem; transition: 0.3s; }
        .select-btn.active { border-color: var(--gold); background: rgba(255,215,0,0.15); box-shadow: 0 0 20px rgba(255,215,0,0.3); color: var(--gold); }

        /* Slider */
        input[type=range] { width: 100%; height: 10px; border-radius: 5px; background: #2d3748; accent-color: var(--gold); }

        /* Fair Info Modal */
        .fair-info-box { 
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)), url('https://i.postimg.cc/XJfvQK5S/IMG-20260115-210549.png');
            background-size: cover; background-position: center; border-radius: 18px; padding: 20px; border: 1px solid var(--gold); display: none; margin: 15px 0;
        }

        /* History Table */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        .history-table th { color: var(--gold); text-align: left; padding: 12px 8px; border-bottom: 1px solid #2d3748; }
        .history-table td { padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .status-win { color: #10b981; font-weight: bold; }
        .status-loss { color: #ef4444; font-weight: bold; }
        .status-pending { color: var(--gold); font-style: italic; }

        /* Navigation */
        nav { position: fixed; bottom: 0; width: 100%; background: var(--card); display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid var(--gold); box-shadow: 0 -5px 25px rgba(0,0,0,0.5); z-index: 1000; }
        .nav-item { text-align: center; font-size: 0.75rem; opacity: 0.4; color: var(--text); cursor: pointer; }
        .nav-item.active { opacity: 1; color: var(--gold); transform: translateY(-3px); transition: 0.3s; }
        .nav-item i { font-size: 1.6rem; margin-bottom: 4px; }

        .hidden { display: none; }
    </style>
</head>
<body>

    <header>
        <div onclick="toggleTheme()" style="cursor: pointer; font-size: 1.3rem;"><i class="fas fa-moon" id="theme-icon"></i></div>
        <div id="ton-connect"></div>
    </header>

    <div class="container">
        <div id="lobby-section">
            <div class="glass-card">
                <img src="https://i.postimg.cc/XJfvQK5S/IMG-20260115-210549.png" class="banner-img">
                <h2 style="color: var(--gold); margin: 5px 0;">Golden ODD-EVEN</h2>
                <p style="opacity: 0.7; font-size: 0.9rem;">Fair, Instant & Global ODD-EVEN Game on TON.</p>
                
                <div style="margin: 20px 0; text-align: center;">
                    <div onclick="toggleFairInfo()" style="cursor: pointer; display: inline-flex; align-items: center; gap: 8px; color: var(--gold); font-weight: 600;">
                        <i class="fas fa-file-contract" style="font-size: 1.2rem;"></i> Provably Fair Information
                    </div>
                    <div id="fair-modal" class="fair-info-box">
                        <h4 style="color: var(--gold); margin-bottom: 10px;">Transparency Verified</h4>
                        <p style="text-align: left; font-size: 0.85rem; line-height: 1.6;">
                            Our game uses the <b>nativePrepareRandom()</b> function of the Tact Smart Contract. Every outcome is calculated on-chain, making it impossible for anyone to manipulate results. You can verify every transaction on the TON Explorer.
                        </p>
                    </div>
                </div>

                <button class="btn-main" onclick="showSection('play')">PLAY NOW</button>
            </div>
        </div>

        <div id="play-section" class="hidden">
            <div class="glass-card">
                <img src="https://i.postimg.cc/8zfNZBQP/IMG-20260115-210803.png" class="banner-img" style="height: 140px; object-fit: cover;">
                
                <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 1.1rem; margin-bottom: 15px;">
                    <span>Bet: <span id="bet-display" style="color: var(--gold);">0.1</span> TON</span>
                    <span>Potential Win: <span id="win-display" style="color: #10b981;">0.19</span> TON</span>
                </div>
                
                <input type="range" min="0.1" max="1.0" step="0.1" value="0.1" id="bet-slider" oninput="updateBetUI(this.value)">

                <div class="selection-grid">
                    <button id="btn-even" class="select-btn" onclick="setSide(true)">EVEN</button>
                    <button id="btn-odd" class="select-btn" onclick="setSide(false)">ODD</button>
                </div>
                
                <button class="btn-main" onclick="handlePlaceBet()">PLACE BET NOW</button>
            </div>

            <div class="glass-card">
                <h3 style="margin-top:0; font-size: 1rem; color: var(--gold);"><i class="fas fa-globe"></i> Global Live History</h3>
                <div style="overflow-x: auto;">
                    <table class="history-table">
                        <thead>
                            <tr><th>Player</th><th>Amount</th><th>Status</th></tr>
                        </thead>
                        <tbody id="history-rows">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="invite-section" class="hidden">
            <div class="glass-card" style="text-align: center;">
                <i class="fas fa-users-viewfinder" style="font-size: 3.5rem; color: var(--gold); margin-bottom: 15px;"></i>
                <h2>Referral Program</h2>
                <p style="opacity: 0.8; font-size: 0.9rem; padding: 0 10px;">
                    Invite your friends and earn <b style="color: var(--gold);">10% commission</b> instantly to your referral balance for every bet they lose.
                </p>
                
                <div style="margin: 25px 0;">
                    <span style="font-size: 0.8rem; opacity: 0.6;">Available Rewards</span>
                    <h1 id="ref-balance-ui" style="color: var(--gold); margin: 5px 0; font-size: 2.5rem;">0.00 TON</h1>
                </div>

                <button class="btn-main" onclick="handleWithdrawRef()">WITHDRAW REWARDS</button>
                
                <div style="margin-top:30px; background:rgba(0,0,0,0.2); padding:15px; border-radius:15px; border: 1px dashed var(--gold);">
                    <p id="ref-url-text" style="font-size: 0.8rem; word-break: break-all; color: var(--gold); font-family: monospace;">Please connect wallet...</p>
                    <button id="copy-btn" onclick="copyInviteLink()" style="margin-top:10px; padding:10px 20px; background:var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer; color:#000;">COPY LINK</button>
                </div>
            </div>
        </div>
    </div>

    <nav>
        <div class="nav-item active" id="nav-lobby" onclick="showSection('lobby')">
            <i class="fas fa-gamepad"></i><br>Lobby
        </div>
        <div class="nav-item" id="nav-invite" onclick="showSection('invite')">
            <i class="fas fa-gift"></i><br>Invite
        </div>
    </nav>

    <script>
        const CONTRACT_ADDRESS = "EQDrMfp_8qbmmnp6mNsg-arxKY2oNvic1kmWovr6_2kFVNK";
        const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
            manifestUrl: 'https://phyothetnaing985.github.io/ton-odd-even-game-live/tonconnect-manifest.json',
            buttonRootId: 'ton-connect'
        });

        let currentSide = null;
        let currentBet = 0.1;

        function updateBetUI(v) {
            currentBet = parseFloat(v);
            document.getElementById('bet-display').innerText = currentBet.toFixed(1);
            document.getElementById('win-display').innerText = (currentBet * 1.9).toFixed(2);
        }

        function setSide(s) {
            currentSide = s;
            document.getElementById('btn-even').classList.toggle('active', s);
            document.getElementById('btn-odd').classList.toggle('active', !s);
        }

        function showSection(id) {
            ['lobby', 'play', 'invite'].forEach(s => document.getElementById(s + '-section').classList.add('hidden'));
            document.getElementById(id + '-section').classList.remove('hidden');
            document.getElementById('nav-lobby').classList.toggle('active', id === 'lobby' || id === 'play');
            document.getElementById('nav-invite').classList.toggle('active', id === 'invite');

            if (id === 'invite' && tonConnectUI.account) {
                document.getElementById('ref-url-text').innerText = window.location.origin + window.location.pathname + "?ref=" + tonConnectUI.account.address;
            }
        }

        async function handlePlaceBet() {
            if (!tonConnectUI.connected) return alert("Please connect wallet first!");
            if (currentSide === null) return alert("Please select ODD or EVEN!");

            try {
                const tonWeb = new TonWeb();
                const cell = new TonWeb.boc.Cell();
                cell.bits.writeUint(0x65228565, 32); // FIXED Bet Opcode
                cell.bits.writeBit(currentSide);

                const ref = new URLSearchParams(window.location.search).get('ref');
                if (ref && TonWeb.Address.isValid(ref)) {
                    cell.bits.writeBit(1);
                    cell.bits.writeAddress(new TonWeb.utils.Address(ref));
                } else {
                    cell.bits.writeBit(0);
                }

                const tx = {
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{
                        address: CONTRACT_ADDRESS,
                        amount: TonWeb.utils.toNano(currentBet.toString()).toString(),
                        payload: TonWeb.utils.bytesToBase64(await cell.toBoc())
                    }]
                };
                await tonConnectUI.sendTransaction(tx);
                alert("Bet Placed! Check the History in a few seconds.");
            } catch (e) { alert("Transaction error: " + e.message); }
        }

        // FIXED Withdraw System (Plain Text Comment)
        async function handleWithdrawRef() {
            if (!tonConnectUI.connected) return alert("Connect Wallet!");
            try {
                const tonWeb = new TonWeb();
                const payload = TonWeb.utils.stringToBytes("WithdrawRef");

                await tonConnectUI.sendTransaction({
                    validUntil: Math.floor(Date.now() / 1000) + 300,
                    messages: [{
                        address: CONTRACT_ADDRESS,
                        amount: TonWeb.utils.toNano("0.05").toString(),
                        payload: TonWeb.utils.bytesToBase64(payload)
                    }]
                });
            } catch (e) { alert("Withdraw failed: " + e.message); }
        }

        // SMART HISTORY SYSTEM
        async function fetchHistory() {
            try {
                const res = await fetch(`https://toncenter.com/api/v2/getTransactions?address=${CONTRACT_ADDRESS}&limit=8`);
                const data = await res.json();
                if (data.ok) {
                    const rows = document.getElementById('history-rows');
                    rows.innerHTML = "";
                    
                    const transactions = data.result;
                    transactions.forEach((tx, index) => {
                        const playerAddr = tx.in_msg.source.slice(0, 4) + "..." + tx.in_msg.source.slice(-4);
                        const betVal = (tx.in_msg.value / 1e9).toFixed(1);
                        
                        // Logic: Look for out_msgs within the same transaction to detect a WIN
                        let statusHtml = '<span class="status-loss">LOSS</span>';
                        if (tx.out_msgs && tx.out_msgs.length > 0) {
                            statusHtml = '<span class="status-win">WIN</span>';
                        } else if (Date.now() / 1000 - tx.utime < 60) {
                            statusHtml = '<span class="status-pending">PENDING...</span>';
                        }

                        rows.innerHTML += `<tr>
                            <td>${playerAddr}</td>
                            <td>${betVal} TON</td>
                            <td>${statusHtml}</td>
                        </tr>`;
                    });
                }
            } catch (e) { console.log("History fetch failed"); }
        }

        function copyInviteLink() {
            const link = document.getElementById('ref-url-text').innerText;
            navigator.clipboard.writeText(link).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerText = "COPIED!"; btn.style.background = "#10b981";
                setTimeout(() => { btn.innerText = "COPY LINK"; btn.style.background = "var(--gold)"; }, 2000);
            });
        }

        function toggleFairInfo() { const m = document.getElementById('fair-modal'); m.style.display = m.style.display === 'block' ? 'none' : 'block'; }
        function toggleTheme() { 
            document.body.classList.toggle('light-mode');
            const icon = document.getElementById('theme-icon');
            icon.classList.toggle('fa-moon'); icon.classList.toggle('fa-sun');
        }

        setInterval(fetchHistory, 10000); 
        fetchHistory();
    </script>
</body>
</html>
