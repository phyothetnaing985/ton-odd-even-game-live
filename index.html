<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>TON Odd & Even - Vault Integrated</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://unpkg.com/@tonconnect/ui@latest/dist/tonconnect-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --bg-color: #0b0e11;
            --card-bg: #1e2329;
            --accent-blue: #38bdf8;
            --accent-green: #02c076;
            --text-main: #eaecef;
        }

        body { margin: 0; background: var(--bg-color); color: var(--text-main); font-family: sans-serif; }
        #app-container { display: flex; flex-direction: column; min-height: 100vh; padding-bottom: 75px; }
        .header { display: flex; justify-content: space-between; padding: 15px; background: var(--card-bg); align-items: center; }
        .screen { display: none; flex-direction: column; align-items: center; padding: 15px; }
        
        /* Game Cards & Images */
        .game-card { background: var(--card-bg); border-radius: 15px; padding: 20px; width: 100%; max-width: 400px; text-align: center; border: 1px solid #333; }
        .banner-img { width: 100%; border-radius: 12px; margin-bottom: 15px; border: 2px solid var(--accent-blue); }
        
        .bet-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 15px 0; }
        .btn-bet { padding: 20px; border-radius: 12px; border: 2px solid #333; background: #0b0e11; color: white; font-weight: bold; cursor: pointer; }
        .btn-bet.active { border-color: var(--accent-blue); box-shadow: 0 0 10px var(--accent-blue); }
        
        .confirm-btn { width: 100%; padding: 16px; border-radius: 12px; border: none; background: var(--accent-green); color: white; font-weight: bold; cursor: pointer; }
        .confirm-btn:disabled { background: #444; color: #888; }

        /* Footer */
        .footer { position: fixed; bottom: 0; width: 100%; height: 65px; background: var(--card-bg); display: flex; border-top: 1px solid #333; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.7rem; color: #848e9c; }
        .nav-item.active { color: var(--accent-blue); }
    </style>
</head>
<body>

<div id="app-container">
    <div class="header">
        <div id="ton-connect-btn"></div>
        <div style="color:var(--accent-green)">Bal: <span id="user-display-bal">0.00</span> T</div>
    </div>

    <div id="lobby-screen" class="screen" style="display: flex;">
        <div class="game-card">
            <img src="https://i.postimg.cc/XJfvQK5S/IMG-20260115-210549.png" class="banner-img" alt="Lobby">
            <h3>ODD & EVEN x1.9</h3>
            <div id="game-ui" style="display:none;">
                <div class="bet-grid">
                    <button class="btn-bet" onclick="selectType('ODD')">ODD</button>
                    <button class="btn-bet" onclick="selectType('EVEN')">EVEN</button>
                </div>
                <input type="range" id="bet-range" min="0.1" max="5" step="0.1" value="0.1" style="width:100%" oninput="document.getElementById('amt').innerText=this.value">
                <p>Bet: <span id="amt" style="color:var(--accent-blue)">0.1</span> TON</p>
                <button id="place-bet-btn" class="confirm-btn" onclick="handleBet()">PLACE BET</button>
            </div>
            <p id="connect-msg">Please connect wallet to play</p>
        </div>
    </div>

    <div id="withdraw-screen" class="screen">
        <div class="game-card">
            <img src="https://i.postimg.cc/8zfNZBQP/IMG-20260115-210803.png" class="banner-img" alt="Wallet">
            <h3>Withdrawal Vault</h3>
            <div style="background:#0b0e11; padding:15px; border-radius:10px; margin-bottom:15px;">
                <p style="margin:0; font-size:0.8rem;">Withdrawable Balance</p>
                <h2 id="withdrawable-bal">0.00 TON</h2>
            </div>
            <button id="withdraw-now-btn" class="confirm-btn" style="background:var(--accent-blue)" onclick="handleWithdraw()" disabled>WITHDRAW NOW</button>
            <hr style="border:0.5px solid #333; margin:20px 0;">
            <p style="font-size:0.8rem;">Referral Bonus: 10% from friend's loss</p>
            <input type="text" id="ref-link" readonly style="width:100%; background:#0b0e11; color:var(--accent-blue); border:1px solid #333; padding:10px; border-radius:5px;" onclick="this.select()">
        </div>
    </div>

    <div class="footer">
        <div class="nav-item active" id="nav-lobby" onclick="showScreen('lobby-screen')"><i class="fas fa-dice"></i><br>Play</div>
        <div class="nav-item" id="nav-withdraw" onclick="showScreen('withdraw-screen')"><i class="fas fa-wallet"></i><br>Vault</div>
    </div>
</div>

<script>
    // --- Config ---
    const VAULT_CONTRACT = "EQAmXMpzRq4JSSI4ak_eJEn_tv9ZMVYxGB5S68UWFZKyuT3I";
    let userBalance = 0.00; // Frontend tracking
    let selectedType = null;

    // --- TonConnect UI (Using a standard Manifest to fix connection issue) ---
    const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
        manifestUrl: 'https://raw.githubusercontent.com/ton-community/tutorials/main/03-client/test/public/tonconnect-manifest.json',
        buttonRootId: 'ton-connect-btn'
    });

    // --- Navigation ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.style.display = 'none');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById(id).style.display = 'flex';
        document.getElementById('nav-' + id.split('-')[0]).classList.add('active');
    }

    // --- Game Logic ---
    function selectType(t) {
        selectedType = t;
        document.querySelectorAll('.btn-bet').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
    }

    async function handleBet() {
        if(!selectedType) return alert("Select ODD or EVEN");
        const amount = document.getElementById('bet-range').value;
        
        const tx = {
            validUntil: Math.floor(Date.now() / 1000) + 300,
            messages: [{
                address: VAULT_CONTRACT,
                amount: (amount * 1000000000).toString(),
                payload: "" // Bet logic is handled by Vault's receive()
            }]
        };

        try {
            await tonConnectUI.sendTransaction(tx);
            Telegram.WebApp.showAlert("Bet Placed! Waiting for result...");
            // Logic: If lost, 10% goes to Referrer balance (Simulated for Frontend)
        } catch (e) { alert("Tx Cancelled"); }
    }

    // --- Withdraw Logic (Vault Integration) ---
    async function handleWithdraw() {
        if(userBalance <= 0) return alert("No balance to withdraw");

        // Tact Message: WithdrawRequest { amount: Int }
        // We send a transaction with a comment/payload that the contract understands
        const tx = {
            validUntil: Math.floor(Date.now() / 1000) + 300,
            messages: [{
                address: VAULT_CONTRACT,
                amount: "50000000", // 0.05 TON for gas
                payload: "te6ccgEBAQEADgAAGFdpdGhkcmF3UmVxdWVzdA==" // Base64 for WithdrawRequest
            }]
        };

        try {
            await tonConnectUI.sendTransaction(tx);
            userBalance = 0;
            updateUI();
            Telegram.WebApp.showAlert("Withdrawal Request Sent to Vault!");
        } catch (e) { alert("Withdraw failed"); }
    }

    function updateUI() {
        document.getElementById('user-display-bal').innerText = userBalance.toFixed(2);
        document.getElementById('withdrawable-bal').innerText = userBalance.toFixed(2) + " TON";
        document.getElementById('withdraw-now-btn').disabled = userBalance <= 0;
    }

    // --- Connection Watcher ---
    tonConnectUI.onStatusChange(wallet => {
        if(wallet) {
            document.getElementById('game-ui').style.display = 'block';
            document.getElementById('connect-msg').style.display = 'none';
            document.getElementById('ref-link').value = "https://t.me/YourBot?start=" + wallet.account.address;
        } else {
            document.getElementById('game-ui').style.display = 'none';
            document.getElementById('connect-msg').style.display = 'block';
        }
    });

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
</script>

</body>
</html>
