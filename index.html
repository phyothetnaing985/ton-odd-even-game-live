<script>
const CONTRACT_ADDRESS = "PUT_DEPLOYED_ADDRESS_HERE";
let selectedSide = null;

const tonConnectUI = new TON_CONNECT_UI.TonConnectUI({
    manifestUrl: "https://phyothetnaing985.github.io/ton-odd-even-game-live/tonconnect-manifest.json",
    buttonRootId: 'ton-connect-btn'
});

const urlParams = new URLSearchParams(window.location.search);
const referrerAddr = urlParams.get('ref');

function selectSide(side) {
    selectedSide = side;
    document.querySelectorAll('.side-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('btn-' + side.toLowerCase()).classList.add('selected');
}

async function handleBet() {
    if (!tonConnectUI.connected) return alert("Connect wallet");
    if (!selectedSide) return alert("Choose ODD or EVEN");

    const betTon = parseFloat(document.getElementById('amt-val').innerText);
    const amount = (betTon * 1e9).toString();

    const cell = new TonWeb.boc.Cell();

    // side: Bool (EVEN = true)
    cell.bits.writeBit(selectedSide === "EVEN");

    // referrer: Address?
    if (referrerAddr && TonWeb.utils.Address.isValid(referrerAddr)) {
        cell.bits.writeBit(true);
        cell.bits.writeAddress(new TonWeb.utils.Address(referrerAddr));
    } else {
        cell.bits.writeBit(false);
    }

    const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

    await tonConnectUI.sendTransaction({
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
            address: CONTRACT_ADDRESS,
            amount: amount,
            payload: payload
        }]
    });
}

async function withdrawRef() {
    const cell = new TonWeb.boc.Cell();
    cell.bits.writeString("WithdrawRef");

    const payload = TonWeb.utils.bytesToBase64(await cell.toBoc());

    await tonConnectUI.sendTransaction({
        validUntil: Math.floor(Date.now() / 1000) + 300,
        messages: [{
            address: CONTRACT_ADDRESS,
            amount: "50000000",
            payload: payload
        }]
    });
}

tonConnectUI.onStatusChange(wallet => {
    if (!wallet) return;
    const addr = wallet.account.address;
    document.getElementById('ref-link').innerText =
        location.origin + location.pathname + "?ref=" + addr;
});
</script>
