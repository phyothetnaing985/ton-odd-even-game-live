<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>TON Odd & Even Game</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script src="https://unpkg.com/@tonconnect/sdk@2.0.0/dist/tonconnect-sdk.min.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
/* ========================================================= */
/* 1. GLOBAL VARIABLES                     */
/* ========================================================= */
:root {
    /* Telegram Web App Theme Colors */
    --tg-theme-bg: #1e1e1e;
    --tg-theme-secondary-bg: #2a2a2a; 
    --tg-theme-text: #ffffff; 
    --tg-theme-hint: #808080;
    --tg-theme-button: #007bff; 
    --tg-theme-button-text: #ffffff;

    /* Custom App Colors */
    --accent-color: #4CAF50; 
    --danger-color: #E74C3C; 
    --card-bg: #2a2a2a;
    --footer-height: 60px;
}

/* ========================================================= */
/* 2. BASE BODY AND SCREEN SETUP           */
/* ========================================================= */
body {
    margin: 0;
    padding: 0;
    background: var(--tg-theme-bg);
    color: var(--tg-theme-text);
    font-family: 'Arial', sans-serif;
    touch-action: manipulation; 
}
 
#app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    padding-bottom: var(--footer-height); 
    box-sizing: border-box;
}

.screen {
    flex-grow: 1;
    display: none; 
    flex-direction: column;
    align-items: center;
    padding: 20px 15px;
    overflow-y: auto; 
}

.header {
    width: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    background-color: var(--card-bg); 
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

#connect-container {
    display: flex;
    align-items: center;
}

.balance, .balance-small {
    display: flex;
    align-items: center;
    font-weight: bold;
    color: var(--tg-theme-text);
}

.diamond-icon {
    margin-right: 5px;
    color: #00bcd4; 
}

/* ========================================================= */
/* 3. CARD & BUTTON STYLES                 */
/* ========================================================= */

.game-card {
    background-color: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
    margin-top: 20px;
    text-align: center;
}

.character-img, .in-game-img {
    width: 100%;
    max-height: 200px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 15px;
}

.connect-btn, .play-button, .confirm-btn, .bet-btn, .back-btn {
    padding: 12px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
    transition: background-color 0.2s;
}

.connect-btn {
    background-color: var(--tg-theme-button);
    color: var(--tg-theme-button-text);
}

.play-button {
    background-color: var(--accent-color);
    color: white;
    width: 100%;
    font-size: 1.1em;
}

.play-button:disabled {
    background-color: var(--tg-theme-secondary-bg);
    color: var(--tg-theme-hint);
    cursor: not-allowed;
}

.confirm-btn {
    background-color: var(--accent-color);
    color: white;
    width: 100%;
    font-size: 1em;
    margin-top: 20px;
}

.bet-selection-group {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.bet-btn {
    flex-grow: 1;
    background-color: var(--tg-theme-secondary-bg);
    color: var(--tg-theme-text);
    border: 1px solid var(--tg-theme-hint);
}

.bet-btn.active {
    background-color: var(--tg-theme-button);
    border-color: var(--tg-theme-button);
    color: var(--tg-theme-button-text);
}

.bet-shortcut-group {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
}
.bet-shortcut-btn {
    background-color: var(--tg-theme-secondary-bg);
    color: var(--tg-theme-text);
    padding: 8px 15px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
}

input[type="range"] {
    width: 100%;
    -webkit-appearance: none;
    appearance: none;
    height: 8px;
    background: var(--tg-theme-secondary-bg);
    border-radius: 5px;
    margin-bottom: 20px;
}

.history-section {
    width: 100%;
    margin-top: 20px;
}
.history-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 10px;
}
.history-table th, .history-table td {
    padding: 8px;
    text-align: left;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.history-table th {
    color: var(--tg-theme-hint);
}
.positive-payout { color: var(--accent-color); font-weight: bold; }
.negative-payout { color: var(--danger-color); }

/* Footer Navigation */
.footer {
    position: fixed;
    bottom: 0;
    width: 100%;
    height: var(--footer-height);
    background-color: var(--card-bg);
    display: flex;
    justify-content: space-around;
    align-items: center;
    box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.3);
    z-index: 100;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
    color: var(--tg-theme-hint);
    transition: color 0.2s;
}

.nav-item.active {
    color: var(--tg-theme-button);
}

/* Utility */
.text-secondary {
    color: var(--tg-theme-hint);
    font-size: 0.9em;
}

.mt-10 { margin-top: 10px; }
    </style>
</head>
<body>

<div id="app-container">
    
    <div class="header">
        <div id="connect-container">
            <button id="connect-wallet-btn" class="connect-btn">Connect Wallet</button>
            <div id="user-info" style="display:none;">
                <span id="user-address-display" class="profile-info"></span>
            </div>
        </div>
        <div id="balance-display" class="balance">
            <span class="diamond-icon">ðŸ’Ž</span> 0.00 TON
        </div>
    </div>

    <div id="lobby-content" class="screen" style="display:none;">
        <div class="game-card">
            <div class="card-content">
                <img src="https://picsum.photos/300/200" alt="ODD & EVEN Lobby" class="character-img">
                <h3 class="card-title">ODD & EVEN (x1.9)</h3>
                <button id="play-button" class="play-button" disabled>Connect Wallet to Play</button>
            </div>
        </div>
    </div>

    <div id="game-content" class="screen" style="display:none;">
        <div class="header">
            <button id="back-to-lobby-from-game" class="back-btn">BACK</button>
            <h2>ODD & EVEN</h2>
            <div id="current-balance" class="balance-small">ðŸ’Ž 0.00 TON</div>
        </div>
        <div class="content-area">
            <div class="game-image-container">
                 <img src="https://picsum.photos/300/250" alt="In Game" class="in-game-img">
            </div>

            <div class="bet-controls">
                <p class="text-secondary">Select your prediction</p>
                <div class="bet-selection-group">
                    <button id="odd-btn" class="bet-btn">ODD (x1.9)</button>
                    <button id="even-btn" class="bet-btn">EVEN (x1.9)</button>
                </div>
                
                <p class="text-secondary">Bet Amount: <span id="bet-amount-display">0.10</span> TON</p>

                <div class="bet-shortcut-group">
                    <button class="bet-shortcut-btn" data-value="0.1">0.1</button>
                    <button class="bet-shortcut-btn" data-value="0.5">0.5</button>
                    <button class="bet-shortcut-btn" data-value="1.0">1.0</button>
                    <button class="bet-shortcut-btn" data-value="max">MAX</button>
                </div>

                <input type="range" id="bet-range" min="0.1" max="1.0" step="0.01" value="0.1">
                
                <button id="confirm-bet-btn" class="confirm-btn" disabled>SELECT ODD/EVEN & BET AMOUNT</button>
            </div>

            <div class="history-section">
                <p class="text-secondary">Recent Game History (Simulated)</p>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Bet</th>
                            <th>Result</th>
                            <th>Payout</th>
                        </tr>
                    </thead>
                    <tbody id="history-body">
                        </tbody>
                </table>
            </div>

        </div>
    </div>

    <div id="withdraw-content" class="screen" style="display:none;">
        <div class="header">
            <button id="back-to-lobby-from-withdraw" class="back-btn">BACK</button>
            <h2>ðŸ’° Withdraw</h2>
        </div>
        <div class="content-area">
            <p class="text-secondary">Your Current Balance</p>
            <h3 id="withdraw-current-balance">10.00 TON</h3>
            <p class="text-secondary small">Minimum withdraw amount is 0.5 TON.</p>
            
            <div class="form-group">
                <label for="withdraw-amount">Amount (TON):</label>
                <input type="number" id="withdraw-amount" placeholder="e.g. 5.00" min="0.5" step="0.01">
            </div>
            <div class="form-group">
                <label for="withdraw-address">TON Destination Address:</label>
                <input type="text" id="withdraw-address" placeholder="EQB...ton wallet">
            </div>
            
            <button id="confirm-withdraw-btn" class="confirm-btn">CONFIRM WITHDRAW</button>
            <p class="text-secondary small mt-10">Minimum withdraw amount is 0.5 TON.</p>
        </div>
    </div>

    <div id="profile-content" class="screen" style="display:none;">
        <div class="header">
            <button id="back-to-lobby-from-profile" class="back-btn">BACK</button>
            <h2>ðŸ‘¤ My Profile</h2>
        </div>
        <div class="game-card">
            <h3 class="card-title">Level 1</h3>
            <p class="text-secondary">250 / 1000 XP to next level</p>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: 25%;"></div>
            </div>
            
            <div class="referral-section">
                <h4>Invite & Earn 10% of Net Loss</h4>
                <p class="text-secondary small">Share your link to get 10% commission on every bet your friends place!</p>
                <div class="referral-input-group">
                    <input type="text" id="referral-link" value="https://t.me/yourgame?ref=1234" readonly>
                    <button id="copy-link-btn" class="copy-btn">COPY LINK</button>
                </div>
                <div class="referral-stats">
                    <p>Total Invited: <span id="total-invited">5</span> users</p>
                    <p>Total Commission Earned: <span id="total-commission">2.50</span> TON</p>
                </div>
            </div>
            <button class="settings-btn">Settings / Help</button>
        </div>
    </div>

    <div class="footer">
        <div id="nav-game" class="nav-item active">
            <i class="fas fa-gamepad"></i>
            <small>Game</small>
        </div>
        <div id="nav-profile" class="nav-item">
            <i class="fas fa-user"></i>
            <small>Profile</small>
        </div>
        <div id="nav-withdraw" class="nav-item">
            <i class="fas fa-wallet"></i>
            <small>Withdraw</small>
        </div>
    </div>

</div>

<script>
// !!! window.onload á€¡á€…á€¬á€¸ DOMContentLoaded á€€á€­á€¯ á€žá€¯á€¶á€¸á€•á€« (Performance/Init Fix) !!!
document.addEventListener('DOMContentLoaded', function() {

    // Check if TonConnect SDK is loaded
    if (typeof TonConnectSDK === 'undefined') {
        console.error("TonConnect SDK is not loaded. Cannot initialize the game.");
        const connectBtn = document.getElementById('connect-wallet-btn');
        if(connectBtn) {
            connectBtn.textContent = "Initialization Error (Reload)";
            connectBtn.disabled = true;
        }
        return;
    }

    // =========================================================
    //                  *** 1. CONFIGURATION & CONSTANTS ***
    // =========================================================
    const REPO_NAME = 'ton-odd-even-game-live'; 
    const GITHUB_USERNAME = 'phyothetnaing985'; 
    const YOUR_RAW_MANIFEST_URL = `https://raw.githubusercontent.com/${GITHUB_USERNAME}/${REPO_NAME}/main/ton-connect.json`;

    // Smart Contract á€™á€›á€¾á€­á€žá€±á€¸á€žá€±á€¬á€ºá€œá€Šá€ºá€¸ Transaction Logic á€¡á€œá€¯á€•á€ºá€œá€¯á€•á€ºá€›á€”á€º Address á€€á€­á€¯ á€‘á€¬á€¸á€›á€¾á€­á€žá€Šá€º
    const GAME_CONTRACT_ADDRESS = "UQAPTqWqxoLqiAangF4qFAPsi8c1imCoyJWtpALBq2i_y3Q4"; 
    const OP_BET = 1; 
    const GAS_FEE_TON = 0.02; 
    const MAX_BET_TON = 1.00;

    // =========================================================
    //                  *** 2. TON CONNECT SETUP ***
    // =========================================================
    const tonConnect = new TonConnectSDK.TonConnect({
        manifestUrl: YOUR_RAW_MANIFEST_URL, 
        connector: new TonConnectSDK.InjectedConnector(),
    });


    // =========================================================
    //                  *** 3. ELEMENTS & STATE ***
    // =========================================================
    const lobbyContent = document.getElementById('lobby-content');
    const gameContent = document.getElementById('game-content');
    const withdrawContent = document.getElementById('withdraw-content');
    const profileContent = document.getElementById('profile-content');

    const connectWalletBtn = document.getElementById('connect-wallet-btn');
    const playButton = document.getElementById('play-button');
    const balanceDisplay = document.getElementById('balance-display');
    const currentBalanceDisplay = document.getElementById('current-balance');
    const userAddressDisplay = document.getElementById('user-address-display');
    const userInfoContainer = document.getElementById('user-info');
    const oddBtn = document.getElementById('odd-btn');
    const evenBtn = document.getElementById('even-btn');
    const betRange = document.getElementById('bet-range');
    const betAmountDisplay = document.getElementById('bet-amount-display');
    const confirmBetBtn = document.getElementById('confirm-bet-btn');
    const betShortcutBtns = document.querySelectorAll('.bet-shortcut-btn');

    let currentBalance = 10.00; // Simulated TON Balance
    let selectedPrediction = null; 
    let currentScreen = null; 

    // =========================================================
    //                  *** 4. UTILITY & UI FUNCTIONS ***
    // =========================================================

    function switchScreen(screenElement) {
        const screens = [lobbyContent, gameContent, withdrawContent, profileContent];
        
        screens.forEach(el => {
            if (el) el.style.display = 'none';
        });
        
        if (screenElement) {
            screenElement.style.display = 'flex';
            currentScreen = screenElement; 
        }
        updateWalletUI();
        
        // Update footer navigation active state
        document.querySelectorAll('.nav-item').forEach(nav => nav.classList.remove('active'));
        if (currentScreen === lobbyContent || currentScreen === gameContent) {
            document.getElementById('nav-game').classList.add('active');
        } else if (currentScreen === profileContent) {
            document.getElementById('nav-profile').classList.add('active');
        } else if (currentScreen === withdrawContent) {
            document.getElementById('nav-withdraw').classList.add('active');
        }
    }

    function updateWalletUI() {
        const isConnected = tonConnect.connected;
        const userWalletAddress = isConnected ? tonConnect.account.address : null;

        if (isConnected) {
            const shortAddress = userWalletAddress.substring(0, 4) + '...' + userWalletAddress.substring(userWalletAddress.length - 4);
            userAddressDisplay.textContent = shortAddress;
            userInfoContainer.style.display = 'flex';
            connectWalletBtn.style.display = 'none';
            playButton.disabled = false;
            playButton.textContent = 'PLAY NOW';
        } else {
            userInfoContainer.style.display = 'none';
            connectWalletBtn.style.display = 'block';
            playButton.disabled = true;
            playButton.textContent = 'Connect Wallet to Play';
        }
        
        // Update all balance displays
        balanceDisplay.innerHTML = `<span class="diamond-icon">ðŸ’Ž</span> ${currentBalance.toFixed(2)} TON`;
        if (currentBalanceDisplay) currentBalanceDisplay.innerHTML = `<span class="diamond-icon">ðŸ’Ž</span> ${currentBalance.toFixed(2)} TON`;
        
        // Update Withdraw Balance Display (Fix: h3 element ID changed from h1)
        const withdrawBal = document.getElementById('withdraw-current-balance');
        if (withdrawBal) {
            withdrawBal.textContent = `${currentBalance.toFixed(2)} TON`;
        }
    }

    function updateBetAmount(amount) {
        if (!betRange) return;
        
        if (amount) {
            betRange.value = amount;
        }
        let currentRangeAmount = parseFloat(betRange.value);
        
        if (currentRangeAmount < 0.10) currentRangeAmount = 0.10; 
        if (currentRangeAmount > MAX_BET_TON) currentRangeAmount = MAX_BET_TON; 
        
        if (betAmountDisplay) betAmountDisplay.textContent = currentRangeAmount.toFixed(2);
        
        const predictionText = selectedPrediction ? selectedPrediction : 'ODD/EVEN';
        const totalTransactionAmount = (currentRangeAmount + GAS_FEE_TON).toFixed(3); 
        if (confirmBetBtn) confirmBetBtn.textContent = `CONFIRM ${predictionText} & SEND ${totalTransactionAmount} TON`;

        if (confirmBetBtn) {
            if (selectedPrediction && currentRangeAmount >= 0.10) {
                confirmBetBtn.disabled = false;
            } else {
                confirmBetBtn.disabled = true;
            }
        }
    }


    // =========================================================
    //                  *** 5. TRANSACTION LOGIC ***
    // =========================================================

    function createBetMessage(prediction) {
        const predictionBit = prediction === 'ODD' ? 0 : 1; 
        
        const builder = new TonConnectSDK.Cell.Builder();
        builder.storeUint(OP_BET, 32); 
        builder.storeBit(predictionBit); 
        
        builder.storeSlice(new TonConnectSDK.Slice.empty()); 

        return builder.build().toBoc().toString('base64');
    }

    async function sendBetTransaction(betAmount, prediction) {
        if (!tonConnect.connected) {
            alert("Please connect your wallet!");
            return;
        }

        const totalAmount = betAmount + GAS_FEE_TON;
        const totalAmountNanograms = (totalAmount * 1e9).toFixed(0); 

        const transaction = {
            validUntil: Math.floor(Date.now() / 1000) + 300, 
            messages: [
                {
                    address: GAME_CONTRACT_ADDRESS, 
                    amount: totalAmountNanograms, 
                    payload: createBetMessage(prediction), 
                }
            ]
        };
        
        try {
            await tonConnect.sendTransaction(transaction);
            console.log("Transaction sent successfully.");
            alert(`Bet of ${betAmount} TON placed on ${prediction}. Check transaction status! (Simulated deduction)`);
            
                        // Simulate balance update
            currentBalance = Math.max(0, currentBalance - betAmount);
            updateWalletUI(); // Balance update

        } catch (error) {
            console.error("Transaction failed:", error);
            alert("Transaction failed or was rejected. Please check your wallet.");
        }
    }
    
    // =========================================================
    //                  *** 6. EVENT LISTENERS ***
    // =========================================================

    // Wallet Connection/Disconnection Listener
    tonConnect.onStatusChange(wallet => {
        console.log('Wallet status changed:', wallet);
        updateWalletUI();
    });

    // Connect Wallet Button
    if (connectWalletBtn) {
        connectWalletBtn.addEventListener('click', async () => {
            try {
                await tonConnect.connect();
            } catch (error) {
                console.error("Wallet connection failed:", error);
                alert("Could not connect to wallet.");
            }
        });
    }

    // Navigation and Screen Switching
    if (playButton) playButton.addEventListener('click', () => switchScreen(gameContent));
    
    // Footer Navigation
    if (document.getElementById('nav-game')) document.getElementById('nav-game').addEventListener('click', () => switchScreen(lobbyContent));
    if (document.getElementById('nav-profile')) document.getElementById('nav-profile').addEventListener('click', () => switchScreen(profileContent));
    if (document.getElementById('nav-withdraw')) document.getElementById('nav-withdraw').addEventListener('click', () => switchScreen(withdrawContent));

    // Back Buttons
    if (document.getElementById('back-to-lobby-from-game')) document.getElementById('back-to-lobby-from-game').addEventListener('click', () => switchScreen(lobbyContent));
    if (document.getElementById('back-to-lobby-from-withdraw')) document.getElementById('back-to-lobby-from-withdraw').addEventListener('click', () => switchScreen(lobbyContent));
    if (document.getElementById('back-to-lobby-from-profile')) document.getElementById('back-to-lobby-from-profile').addEventListener('click', () => switchScreen(lobbyContent));

    // Bet Selection
    function selectPrediction(prediction) {
        selectedPrediction = prediction;
        oddBtn.classList.remove('active');
        evenBtn.classList.remove('active');
        if (prediction === 'ODD') {
            oddBtn.classList.add('active');
        } else if (prediction === 'EVEN') {
            evenBtn.classList.add('active');
        }
        updateBetAmount(parseFloat(betRange.value)); 
    }

    if (oddBtn) oddBtn.addEventListener('click', () => selectPrediction('ODD'));
    if (evenBtn) evenBtn.addEventListener('click', () => selectPrediction('EVEN'));

    // Bet Amount Control
    if (betRange) {
        betRange.addEventListener('input', () => updateBetAmount(null));
    }
    
    // Bet Shortcuts
    betShortcutBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const val = btn.getAttribute('data-value');
            if (val === 'max') {
                updateBetAmount(MAX_BET_TON);
            } else {
                updateBetAmount(parseFloat(val));
            }
        });
    });

    // Confirm Bet Button
    if (confirmBetBtn) {
        confirmBetBtn.addEventListener('click', () => {
            if (tonConnect.connected && selectedPrediction) {
                const betAmount = parseFloat(betRange.value);
                sendBetTransaction(betAmount, selectedPrediction);
            } else {
                alert("Please select ODD/EVEN and ensure wallet is connected.");
            }
        });
    }

    // Initialize UI
    switchScreen(lobbyContent); 
    updateBetAmount(0.10); // Initialize bet amount display


}); // End of DOMContentLoaded
</script>
</body> 
</html>

